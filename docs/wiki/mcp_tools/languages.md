# Language Validation Tools

Tools for validating MyBB plugin language files against code usage. These tools work exclusively on plugin workspace files, not TestForum.

## Overview

MyBB plugins use language files (`inc/languages/english/*.lang.php`) with `$l['key'] = 'value';` definitions that are accessed in code via `$lang->key` (PHP) or `{$lang->key}` (templates).

These tools help you:
- Find **missing definitions** - code uses `$lang->foo` but `$l['foo']` isn't defined
- Find **unused definitions** - `$l['bar']` is defined but never used
- Detect **potential typos** - `$lang->invite_usercp_invites` vs `$l['invite_usercp_nav']`
- **Generate stubs** for missing definitions

## Tools

### mybb_lang_validate

Validate language files for a plugin workspace.

#### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| codename | string | **REQUIRED** | - | Plugin codename (must exist in workspace) |
| include_templates | bool | optional | `true` | Scan templates for `{$lang->x}` usage |
| fix_suggestions | bool | optional | `true` | Include auto-fix suggestions in output |

#### Returns

Markdown report with:
- Summary of definitions, usages, missing, unused counts
- Table of missing definitions with file:line locations
- Table of unused definitions (safe to remove)
- Table of potential typos with similarity scores
- Dynamic usages that can't be validated (`$lang->$var`)

#### Example

```
mybb_lang_validate(codename="invite_system")
```

Output:
```markdown
# Language Validation Report: `invite_system`

## Summary
- **Definitions:** 1246
- **Usages found:** 1380
- **Template usages:** 312
- **Missing definitions:** 114 ❌
- **Unused definitions:** 349 ⚠️
- **Dynamic usages:** 8 (can't validate)

## Missing Definitions
| Variable | Used In | Line | Context |
|----------|---------|------|---------|
| `invite_tab_logs` | module_meta.php | 416 | php |
| `invite_setting_default_group` | settings.php | 228 | php |
...

## Unused Definitions
| Variable | Defined In | Line | Action |
|----------|-----------|------|--------|
| `invite_old_feature` | invite_system.lang.php | 234 | Safe to remove |
...
```

---

### mybb_lang_generate_stub

Generate PHP code for missing language definitions.

#### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| codename | string | **REQUIRED** | - | Plugin codename |
| output | string | optional | `"stub"` | Output format: `"stub"`, `"patch"`, `"inline"` |
| default_values | string | optional | `"placeholder"` | How to generate values: `"empty"`, `"key_as_value"`, `"placeholder"` |

#### Value Generation Modes

- **empty**: `$l['key'] = '';`
- **key_as_value**: `$l['invite_tab_logs'] = 'Invite Tab Logs';` (converts snake_case to Title Case)
- **placeholder**: `$l['key'] = '[key]';` (visible placeholder)

#### Returns

Generated PHP code for missing definitions, with guidance on which file to add them to.

#### Example

```
mybb_lang_generate_stub(codename="invite_system", default_values="key_as_value")
```

Output:
```php
// Missing language definitions for invite_system
// Generated by mybb_lang_generate_stub

$l['invite_tab_logs'] = 'Invite Tab Logs';
$l['invite_tab_bulk'] = 'Invite Tab Bulk';
$l['invite_tab_help'] = 'Invite Tab Help';
$l['invite_setting_default_group'] = 'Invite Setting Default Group';
// ...
```

---

### mybb_lang_scan_usage

Low-level scan for language variable usage in any path.

#### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| path | string | **REQUIRED** | - | File or directory to scan (relative to repo root or absolute) |
| output | string | optional | `"grouped"` | Output format: `"list"`, `"grouped"`, `"json"` |

#### Output Formats

- **grouped**: Groups usages by variable name (default, most readable)
- **list**: Flat table of all usages with file:line
- **json**: Full JSON output for programmatic use

#### Returns

Scan results showing all `$lang->x` and `{$lang->x}` usages found.

#### Example

```
mybb_lang_scan_usage(path="plugin_manager/plugins/private/invite_system/inc/plugins/invite_system/admin/")
```

Output:
```markdown
# Language Usage Scan: `plugin_manager/.../admin/`

**Unique keys:** 156
**Total usages:** 423

## By Variable

### `invite_admin_dashboard` (5 usages)
- admin/dashboard.php:45 (php)
- admin/dashboard.php:67 (php)
...

### `invite_admin_codes` (12 usages)
- admin/codes.php:23 (php)
- admin/codes.php:89 (php)
...
```

## How It Works

### Scanning Patterns

The validator uses these regex patterns:

- **Definition**: `$l['key']` in `.lang.php` files
- **PHP usage**: `$lang->key` (excludes method calls like `$lang->load()`)
- **Template usage**: `{$lang->key}` in `.html` files

### Core Variables

The validator ignores common MyBB core language variables like:
- `yes`, `no`, `submit`, `cancel`, `save`, `delete`
- `username`, `password`, `email`
- Navigation items, common UI strings

### Admin vs Frontend

The validator distinguishes between:
- **Frontend language file**: `inc/languages/english/{codename}.lang.php`
- **Admin language file**: `inc/languages/english/admin/{codename}.lang.php`

Admin-context files (in `/admin/` paths) should have definitions in the admin language file.

## Workspace Structure

The tools expect this standard plugin workspace structure:

```
plugin_manager/plugins/{visibility}/{codename}/
├── meta.json
├── templates/                     # Scanned for {$lang->x}
│   └── *.html
├── inc/
│   ├── languages/english/
│   │   ├── {codename}.lang.php      # Frontend definitions
│   │   └── admin/{codename}.lang.php # Admin definitions
│   └── plugins/
│       ├── {codename}.php           # Main plugin
│       └── {codename}/              # Plugin subdirectory
│           ├── admin/*.php          # Admin handlers
│           ├── core/*.php           # Core classes
│           └── handlers/*.php       # Frontend handlers
```

## Tips

1. **Run validation regularly** - Add to your workflow before committing
2. **Fix missing definitions promptly** - They cause empty strings or errors at runtime
3. **Review unused definitions** - Remove dead code, but be careful with dynamic usage
4. **Check typo suggestions** - Fuzzy matching catches common mistakes
5. **Use key_as_value** for stub generation - Gives you human-readable starting values

---

See also: [Plugin Development](plugins.md) | [Disk Sync](disk_sync.md) | [Plugin Manager](../plugin_manager/index.md)
