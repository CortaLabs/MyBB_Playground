# Research: MyBB Admin Panel Plugin Activation Flow

**Research Date:** 2026-01-18 07:31 UTC
**Researcher:** ResearchAgent
**Project:** plugin-theme-manager
**Status:** COMPLETE
**Confidence:** 0.95

## Executive Summary

This document provides a **complete technical analysis of the MyBB Admin Panel plugin activation flow**, including:

1. **HTTP Request Routing** — How admin requests are dispatched from `index.php` to module files
2. **Activation Handler Path** — Exact code locations for activate/deactivate actions
3. **Function Execution Sequence** — The precise order of operations during plugin activation
4. **Install vs. Activate Distinction** — When `_install()` vs `_activate()` are called
5. **Cache Operations** — How the plugin cache is updated after activation
6. **Admin Logging** — Automatic audit trail creation
7. **Security Mechanisms** — POST verification and CSRF protection

This research directly enables Phase 7 implementation of MCP tools for plugin installation and activation with full PHP execution.

---

## 1. HTTP Request Routing (Admin CP Entry Point)

### Request Format

Plugin activation is triggered via a link in the Admin CP:

```
/admin/index.php?module=config-plugins&action=activate&plugin={codename}&my_post_key={post_code}
```

**Example from plugins.php line 689:**
```php
"<a href=\"index.php?module=config-plugins&amp;action=activate&amp;plugin={$plugininfo['codename']}&amp;my_post_key={$mybb->post_code}\">..."
```

### URL Parameter Breakdown

| Parameter | Source | Purpose |
|-----------|--------|---------|
| `module=config-plugins` | Admin menu | Routes to config module, plugins subaction |
| `action=activate` | User request | Specifies activation (vs. deactivate) |
| `plugin={codename}` | Plugin list | Which plugin to activate (e.g., "hello") |
| `my_post_key={code}` | Generated by admin CP | CSRF protection token |

### Request Method

Activation uses **GET request** with POST verification key (not a traditional POST form).

---

## 2. Admin Request Routing Mechanism

### Step-by-Step Route Resolution

**File: `TestForum/admin/index.php` (lines 769-834)**

1. **Parse Module-Action Format** (lines 769-776)
   ```php
   if(strpos($mybb->input['module'], "/") !== false)
   {
       $current_module = explode("/", $mybb->input['module'], 2);
   }
   else
   {
       $current_module = explode("-", $mybb->input['module'], 2);
   }
   ```
   - Input: `module=config-plugins`
   - Result: `$current_module = array('config', 'plugins')`

2. **Get Action Handler** (lines 792-793)
   ```php
   $action_handler = $run_module."_action_handler";
   $action_file = $action_handler($current_module[1]);
   ```
   - Calls: `config_action_handler('plugins')`
   - Returns: `"plugins.php"`

3. **Generate POST Code** (line 796)
   ```php
   $mybb->post_code = generate_post_check();
   ```
   - Creates fresh validation token for current page

4. **Verify POST Check** (lines 808-828)
   ```php
   if($mybb->request_method == "post")
   {
       if(!verify_post_check($mybb->get_input('my_post_key'), true))
       {
           $mybb->request_method = "get";
           $page->show_post_verify_error = true;
       }
   }
   ```

5. **Include Module File** (line 834)
   ```php
   require $modules_dir."/".$run_module."/".$action_file;
   ```
   - Includes: `admin/modules/config/plugins.php`

### Action Handler Dispatch

**File: `TestForum/admin/modules/config/module_meta.php` (lines 56-95)**

```php
function config_action_handler($action)
{
    // ...
    $actions = array(
        'plugins' => array('active' => 'plugins', 'file' => 'plugins.php'),
        // ... other actions
    );

    if(isset($actions[$action]))
    {
        $page->active_action = $actions[$action]['active'];
        return $actions[$action]['file'];  // Returns 'plugins.php'
    }
}
```

---

## 3. POST Verification (CSRF Protection)

### POST Check Generation

**File: `TestForum/inc/functions.php` (lines 707-733)**

```php
function generate_post_check($rotation_shift=0)
{
    global $mybb, $session;

    $rotation_interval = 6 * 3600;  // 6 hours
    $rotation = floor(TIME_NOW / $rotation_interval) + $rotation_shift;

    $seed = $rotation;

    if($mybb->user['uid'])
    {
        $seed .= $mybb->user['loginkey'].$mybb->user['salt'].$mybb->user['regdate'];
    }
    else
    {
        $seed .= $session->sid;
    }

    if(defined('IN_ADMINCP'))
    {
        $seed .= 'ADMINCP';  // Admin-specific suffix
    }

    $seed .= $mybb->settings['internal']['encryption_key'];

    return md5($seed);
}
```

**Key Points:**
- 6-hour rotation interval
- User-specific seed (loginkey, salt, regdate for authenticated users)
- Admin CP adds 'ADMINCP' suffix to seed
- Accepts current + 3 past rotations (24 hours total validity)

### POST Check Verification

**File: `TestForum/inc/functions.php` (lines 742-772)**

```php
function verify_post_check($code, $silent=false)
{
    global $lang;
    if(
        generate_post_check() !== $code &&
        generate_post_check(-1) !== $code &&
        generate_post_check(-2) !== $code &&
        generate_post_check(-3) !== $code
    )
    {
        if($silent == true)
        {
            return false;  // Return false silently
        }
        // ... error handling
    }
    else
    {
        return true;  // Valid token
    }
}
```

**Verification Flow:**
1. Check current rotation code
2. Check -1 rotation (6 hours ago)
3. Check -2 rotation (12 hours ago)
4. Check -3 rotation (18 hours ago)
5. Accept if ANY match

---

## 4. Plugin Activation Handler

### Main Activation Code

**File: `TestForum/admin/modules/config/plugins.php` (lines 376-482)**

This is the **CORE ACTIVATION LOGIC**.

#### Phase 1: Pre-Activation Validation (lines 376-414)

```php
if($mybb->input['action'] == "activate" || $mybb->input['action'] == "deactivate")
{
    // 1. Verify POST check
    if(!verify_post_check($mybb->get_input('my_post_key')))
    {
        flash_message($lang->invalid_post_verify_key2, 'error');
        admin_redirect("index.php?module=config-plugins");
    }

    // 2. Run pre-activation hook
    if($mybb->input['action'] == "activate")
    {
        $plugins->run_hooks("admin_config_plugins_activate");
    }

    // 3. Sanitize plugin name
    $codename = $mybb->input['plugin'];
    $codename = str_replace(array(".", "/", "\\"), "", $codename);
    $file = basename($codename.".php");

    // 4. Check if plugin file exists
    if(!file_exists(MYBB_ROOT."inc/plugins/$file"))
    {
        flash_message($lang->error_invalid_plugin, 'error');
        admin_redirect("index.php?module=config-plugins");
    }

    // 5. Read current plugin cache
    $plugins_cache = $cache->read("plugins");
    $active_plugins = isset($plugins_cache['active']) ? $plugins_cache['active'] : array();

    // 6. Include plugin file
    require_once MYBB_ROOT."inc/plugins/$file";

    // 7. Check if plugin is installed
    $installed_func = "{$codename}_is_installed";
    $installed = true;
    if(function_exists($installed_func) && $installed_func() != true)
    {
        $installed = false;
    }
}
```

#### Phase 2: Activation Logic (lines 418-444)

```php
if($mybb->input['action'] == "activate")
{
    $message = $lang->success_plugin_activated;

    // 1. Check compatibility
    if($plugins->is_compatible($codename) == false)
    {
        flash_message($lang->sprintf($lang->plugin_incompatible, $mybb->version), 'error');
        admin_redirect("index.php?module=config-plugins");
    }

    // 2. If NOT installed and _install() exists: CALL INSTALL FIRST
    if($installed == false && function_exists("{$codename}_install"))
    {
        call_user_func("{$codename}_install");
        $message = $lang->success_plugin_installed;
        $install_uninstall = true;
    }

    // 3. Call _activate() if it exists
    if(function_exists("{$codename}_activate"))
    {
        call_user_func("{$codename}_activate");
    }

    // 4. Add to active plugins list
    $active_plugins[$codename] = $codename;
    $executed[] = 'activate';
}
```

#### Phase 3: Cache Update & Logging (lines 464-478)

```php
// Update plugin cache
$plugins_cache['active'] = $active_plugins;
$cache->update("plugins", $plugins_cache);

// Log admin action
log_admin_action($codename, $install_uninstall);

// Run post-activation hook
if($mybb->input['action'] == "activate")
{
    $plugins->run_hooks("admin_config_plugins_activate_commit");
}

// Flash message and redirect
flash_message($message, 'success');
admin_redirect("index.php?module=config-plugins");
```

---

## 5. Admin Logging

### Log Entry Creation

**File: `TestForum/admin/inc/functions.php` (lines 14-40)**

```php
function log_admin_action()
{
    global $db, $mybb;

    $data = func_get_args();

    if(count($data) == 1 && is_array($data[0]))
    {
        $data = $data[0];
    }

    if(!is_array($data))
    {
        $data = array($data);
    }

    $log_entry = array(
        "uid" => (int)$mybb->user['uid'],
        "ipaddress" => $db->escape_binary(my_inet_pton(get_ip())),
        "dateline" => TIME_NOW,
        "module" => $db->escape_string($mybb->get_input('module')),  // "config"
        "action" => $db->escape_string($mybb->get_input('action')),  // "activate"
        "data" => $db->escape_string(@my_serialize($data))           // plugin codename
    );

    $db->insert_query("adminlog", $log_entry);
}
```

**Log Entry Example for Plugin Activation:**
```
module:    "config"
action:    "activate"
data:      "hello"  (serialized: s:5:"hello";)
uid:       1
ipaddress: admin's IP
dateline:  current timestamp
```

---

## 6. Plugin Lifecycle Function Execution

### Function Call Sequence During Activation

**For a NEW plugin (not previously installed):**

1. **Check `{codename}_is_installed()`** → Returns FALSE
2. **Call `{codename}_install()`** (if exists)
   - Creates database tables
   - Sets up initial data structures
   - Example: hello_install() creates `mybb_hello_messages` table
3. **Call `{codename}_activate()`** (if exists)
   - Adds templates to database
   - Updates language strings
   - Hooks into plugin system
   - Example: hello_activate() inserts hello_index, hello_post, hello_message templates

**For an EXISTING but INACTIVE plugin:**

1. **Check `{codename}_is_installed()`** → Returns TRUE
2. **Skip `{codename}_install()`**
3. **Call `{codename}_activate()`** immediately

### Example: hello.php Lifecycle

**hello_info() (line 58)**
```php
function hello_info()
{
    return array(
        'name' => 'Hello World!',
        'description' => $lang->hello_desc,
        'codename' => 'hello',
        'version' => '2.0',
        'compatibility' => '18*'
    );
}
```

**hello_install() (line 353)**
```php
function hello_install()
{
    global $db;
    if(!$db->table_exists('hello_messages'))
    {
        $db->write_query("CREATE TABLE ".TABLE_PREFIX."hello_messages (
            mid int unsigned NOT NULL auto_increment,
            message varchar(100) NOT NULL default '',
            PRIMARY KEY (mid)
        ) ENGINE=MyISAM{$collation};");
    }
}
```

**hello_activate() (line 91)**
```php
function hello_activate()
{
    global $db, $lang;
    $lang->load('hello');

    // Insert templates into database
    $templatearray = array(
        'index' => '...',  // hello_index template
        'post' => '...',   // hello_post template
        'message' => '...' // hello_message template
    );

    // Create/update template group
    $group = array('prefix' => 'hello', 'title' => 'Hello World!');

    // Insert/update templates in DB...
}
```

**hello_is_installed() (line 395)**
```php
function hello_is_installed()
{
    global $db;
    return $db->table_exists('hello_messages');
}
```

---

## 7. Deactivation Flow

### Deactivation Handler (lines 445-462)

```php
else if($mybb->input['action'] == "deactivate")
{
    $message = $lang->success_plugin_deactivated;

    // 1. Call _deactivate() if exists
    if(function_exists("{$codename}_deactivate"))
    {
        call_user_func("{$codename}_deactivate");
    }

    // 2. If uninstall flag set, call _uninstall()
    if($mybb->get_input('uninstall') == 1 && function_exists("{$codename}_uninstall"))
    {
        call_user_func("{$codename}_uninstall");
        $message = $lang->success_plugin_uninstalled;
        $install_uninstall = true;
    }

    // 3. Remove from active plugins
    unset($active_plugins[$codename]);
}
```

**Key Distinction:**
- **Deactivate-only**: Calls `_deactivate()`, plugin stays installed, can be re-activated
- **Deactivate + Uninstall**: Calls `_deactivate()`, then `_uninstall()`, removes all traces

---

## 8. Cache System

### Plugin Cache Structure

**File: Cache titled `plugins`**

```php
$plugins_cache = array(
    'active' => array(
        'hello' => 'hello',
        'another_plugin' => 'another_plugin',
        // ...
    )
);
```

### Cache Update During Activation

**Code: lines 464-466**

```php
$plugins_cache['active'] = $active_plugins;  // Add plugin to active list
$cache->update("plugins", $plugins_cache);   // Rebuild cache file
```

**What happens:**
1. `$cache->read("plugins")` - Load current active plugins
2. Add/remove plugin from `$active_plugins` array
3. `$cache->update("plugins", ...)` - Write back to cache file
4. MyBB frontend sees plugin in active list on next page load

---

## 9. Hook System

### Available Hooks for Plugin Activation

Hooks allow other plugins to intercept or extend activation process:

**Pre-Activation Hook (line 386):**
```php
$plugins->run_hooks("admin_config_plugins_activate");
```
- Fires BEFORE activation validation
- Other plugins can prevent activation

**Post-Activation Hook (line 473):**
```php
$plugins->run_hooks("admin_config_plugins_activate_commit");
```
- Fires AFTER cache update
- Safe to perform dependent operations

**Deactivation Hooks (lines 390, 477):**
```php
$plugins->run_hooks("admin_config_plugins_deactivate");
$plugins->run_hooks("admin_config_plugins_deactivate_commit");
```

---

## 10. Error Handling

### Failure Scenarios

| Scenario | Handler | Result |
|----------|---------|--------|
| Invalid POST key | lines 378-382 | Error message, redirect to plugins list |
| Plugin file not found | lines 397-402 | Error message, redirect |
| Incompatible version | lines 423-427 | Error message, redirect (activation blocked) |
| `_is_installed()` check fails | Unhandled | Continues to install/activate |

### Error Messages

All errors use `flash_message()` which sets a session-stored notification:

```php
flash_message($lang->error_invalid_plugin, 'error');
admin_redirect("index.php?module=config-plugins");
```

---

## 11. Complete Activation Flow Diagram

```
HTTP Request: /admin/index.php?module=config-plugins&action=activate&plugin=hello&my_post_key=ABC123

│
├─→ admin/index.php (lines 769-834)
│   ├─ Parse "config-plugins" → ['config', 'plugins']
│   ├─ Call config_action_handler('plugins') → returns "plugins.php"
│   ├─ Generate fresh POST code: generate_post_check()
│   ├─ Verify incoming POST key: verify_post_check('ABC123')
│   └─ Require admin/modules/config/plugins.php
│
└─→ admin/modules/config/plugins.php (lines 376-482)
    │
    ├─→ VALIDATION PHASE
    │   ├─ Verify POST check again
    │   ├─ Sanitize codename: str_replace([".", "/", "\\"], "", "hello")
    │   ├─ Check file exists: MYBB_ROOT."inc/plugins/hello.php"
    │   ├─ Load plugin cache
    │   └─ require_once inc/plugins/hello.php
    │
    ├─→ COMPATIBILITY CHECK
    │   └─ $plugins->is_compatible('hello') → version check
    │
    ├─→ INSTALLATION PHASE (if not installed)
    │   ├─ Check hello_is_installed() → FALSE
    │   └─ Call hello_install()
    │       └─ CREATE TABLE mybb_hello_messages
    │
    ├─→ ACTIVATION PHASE
    │   └─ Call hello_activate()
    │       ├─ INSERT templates into DB
    │       ├─ CREATE/UPDATE template group
    │       └─ REGISTER hooks
    │
    ├─→ CACHE UPDATE
    │   ├─ Add 'hello' to $active_plugins['hello'] = 'hello'
    │   └─ $cache->update("plugins", $plugins_cache)
    │
    ├─→ LOGGING
    │   └─ log_admin_action('hello', true)
    │       └─ INSERT INTO adminlog (module='config', action='activate', data='hello')
    │
    ├─→ POST-ACTIVATION HOOKS
    │   └─ $plugins->run_hooks("admin_config_plugins_activate_commit")
    │
    └─→ Redirect: admin_redirect("index.php?module=config-plugins")
        └─ HTTP 302 redirect
```

---

## 12. Code References - Complete Line Map

| Component | File | Lines | Purpose |
|-----------|------|-------|---------|
| HTTP routing | TestForum/admin/index.php | 769-776 | Parse module-action |
| Action handler | TestForum/admin/index.php | 792-793 | Get action file |
| POST generation | TestForum/admin/index.php | 796 | Generate fresh token |
| POST verify | TestForum/admin/index.php | 808-828 | Verify incoming token |
| Module include | TestForum/admin/index.php | 834 | Include plugins.php |
| Action dispatch | TestForum/admin/modules/config/module_meta.php | 56-95 | Map action to file |
| POST check gen | TestForum/inc/functions.php | 707-733 | Generate validation code |
| POST check verify | TestForum/inc/functions.php | 742-772 | Verify validation code |
| Activation handler | TestForum/admin/modules/config/plugins.php | 376-482 | Main activation logic |
| Admin logging | TestForum/admin/inc/functions.php | 14-40 | Log action |
| hello.info | TestForum/inc/plugins/hello.php | 58-84 | Plugin metadata |
| hello.activate | TestForum/inc/plugins/hello.php | 91-330 | Activation routine |
| hello.install | TestForum/inc/plugins/hello.php | 353-387 | Installation routine |
| hello.is_installed | TestForum/inc/plugins/hello.php | 395-401 | Check installed status |

---

## 13. Key Discoveries & Insights

### 1. **Installation Happens During Activation**
When a plugin is activated for the first time:
- `_install()` is called FIRST (if plugin not installed)
- `_activate()` is called AFTER installation
- This is handled automatically by the admin panel logic (line 430)

### 2. **POST Verification Uses 6-Hour Rotation**
- POST codes rotate every 6 hours
- Admin CP accepts codes from last 4 rotations (24 hours total)
- Each admin user has unique seed based on loginkey+salt+regdate
- Admin CP adds 'ADMINCP' suffix to prevent cross-use

### 3. **Cache is Updated AFTER All Functions Execute**
- Plugin `_install()` and `_activate()` execute with STALE cache
- Cache is rebuilt only after both complete (line 466)
- This prevents race conditions if activation fails midway

### 4. **Two Types of POST Checks**
- **Incoming request verification** (line 378): Prevents CSRF, checks my_post_key param
- **Template generation** (line 796): Fresh token for next page

### 5. **Admin Logging is Automatic**
- Every activation/deactivation is logged
- Log entry contains: module, action, data (codename), admin UID, IP, timestamp
- Data field serialized if array passed

### 6. **Hooks Allow Plugin Interception**
- `admin_config_plugins_activate` - Pre-activation hook (can prevent)
- `admin_config_plugins_activate_commit` - Post-activation hook (safe for dependent ops)

---

## 14. Unverified Items & Gaps

1. **$plugins->is_compatible()** implementation - How version checking works (UNVERIFIED)
2. **Flash message session storage** - Where messages are stored between requests (UNVERIFIED)
3. **Template inheritance resolution** - How custom templates are resolved over master (UNVERIFIED - see previous research)

---

## 15. Handoff to Architect

### Critical Design Constraints

1. **MCP tools cannot call PHP directly** - Activation requires include_once + call_user_func on plugin files
2. **Cache updates are atomic** - Must wait for all functions before updating
3. **Installation is one-time** - _install() should only run if plugin not already installed
4. **POST verification required** - Any activation via web must verify my_post_key parameter

### Phase 7 Tool Design Considerations

For `mybb_plugin_install()` and `mybb_plugin_activate()`:

1. Must run within MyBB bootstrap context (MYBB_ROOT available)
2. Must load plugin file: `require_once MYBB_ROOT."inc/plugins/{codename}.php"`
3. Must call `{codename}_is_installed()` before `{codename}_install()`
4. Must call functions in order: install (conditional) → activate
5. Must update plugin cache after both complete
6. Must create admin log entry
7. Consider snapshot hooks approach for long-running operations

---

## References

- MyBB Admin CP: TestForum/admin/index.php
- Config Module: TestForum/admin/modules/config/module_meta.php
- Plugin Handler: TestForum/admin/modules/config/plugins.php
- Security Functions: TestForum/inc/functions.php
- Example Plugin: TestForum/inc/plugins/hello.php
- Admin Functions: TestForum/admin/inc/functions.php

---

**Research Complete** ✓
**Confidence:** 0.95 (High - verified with code references)
**Ready for Architecture Phase**
